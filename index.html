<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Lakshmi Narasimha Devasthan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;900&display=swap');
        
        :root {
            --brand-primary: #7f1d1d;
            --brand-gold: #b45309;
            --brand-cream: #fdfcf8;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--brand-cream);
            color: #1a1a1a;
            -webkit-tap-highlight-color: transparent;
            user-select: text;
        }

        .serif-title {
            font-family: 'Playfair Display', serif;
        }

        .hero-pattern {
            background-color: #7f1d1d;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M0 0h40v40H0V0zm40 40h40v40H40V40zm0-40h2l-2 2V0zm0 4l4-4h2l-6 6V4zm0 4l8-8h2L40 10V8zm0 4l10-10h2L40 14v-2zm0 4l12-12h2L40 18v-2zm0 4l14-14h2L40 22v-2zm0 4l16-16h2L40 26v-2zm0 4l18-18h2L40 30v-2zm0 4l20-20h2L40 34v-2zm0 4l22-22h2L40 38v-2zm0 4l24-24h2L40 42v-2z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(127, 29, 29, 0.08);
        }

        .modal-overlay {
            background-color: rgba(26, 12, 12, 0.7);
            backdrop-filter: blur(12px);
        }

        .sticky-search {
            background: rgba(253, 252, 248, 0.9);
            backdrop-filter: blur(10px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--brand-cream); }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-item {
            animation: fadeIn 0.4s ease forwards;
        }

        .past-event {
            opacity: 0.8;
        }

        /* Toggle Button Styles */
        .view-toggle-btn.active {
            background-color: white;
            color: var(--brand-primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Hero Header -->
    <header class="hero-pattern text-white pt-16 pb-20 px-6 relative overflow-hidden text-center">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-4xl h-full opacity-10 pointer-events-none flex justify-between px-10 items-center">
            <i class="fas fa-om text-9xl"></i>
            <i class="fas fa-dharmachakra text-9xl"></i>
        </div>
        <div class="max-w-4xl mx-auto relative z-10">
            <span class="inline-block px-4 py-1 rounded-full bg-white/10 text-white/80 text-[10px] font-bold uppercase tracking-[0.2em] mb-4">Om Namo Narasimhaya</span>
            <h1 class="serif-title text-3xl md:text-5xl font-black tracking-tight leading-tight">
                Sri Lakshmi Narasimha <br class="hidden md:block"> Devasthan
            </h1>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 flex-grow w-full pb-40">
        
        <!-- Search & Control -->
        <div class="sticky-search sticky top-4 z-30 -mt-6 rounded-2xl card-shadow p-3 border border-red-50/50">
            <div class="relative w-full">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="fas fa-search text-xs"></i>
                </span>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search all events or dates..." 
                    class="w-full pl-11 pr-10 py-3.5 bg-gray-50/50 border border-gray-100 rounded-xl focus:outline-none focus:ring-4 focus:ring-red-800/5 focus:border-red-800/30 transition-all text-gray-700 text-sm"
                >
                <button id="clearSearch" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-300 hover:text-gray-500 hidden">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
        </div>

        <!-- View Toggle Tabs -->
        <div class="mt-8 px-1">
            <div class="bg-gray-100/80 p-1 rounded-2xl flex items-center space-x-1">
                <button onclick="setView('upcoming')" id="tab-upcoming" class="view-toggle-btn active flex-1 py-3 px-4 rounded-xl text-[11px] font-bold uppercase tracking-widest transition-all">
                    Upcoming
                </button>
                <button onclick="setView('past')" id="tab-past" class="view-toggle-btn flex-1 py-3 px-4 rounded-xl text-[11px] font-bold uppercase tracking-widest transition-all text-gray-400">
                    Past Records
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center px-2 mt-8 mb-6">
            <div class="flex flex-col">
                <h2 id="viewTitle" class="text-xs font-extrabold text-gray-800 uppercase tracking-widest flex items-center">
                    <span class="w-2 h-2 bg-red-800 rounded-full mr-2"></span>
                    Upcoming Registry
                </h2>
                <span id="eventCount" class="text-[9px] font-bold text-red-800/40 uppercase mt-1">Loading...</span>
            </div>
            <button id="copyBtn" onclick="copyEvents()" class="bg-red-50 text-red-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-red-100 transition-colors flex items-center">
                <i class="far fa-copy mr-2"></i> Copy List
            </button>
        </div>

        <!-- Skeleton Loading -->
        <div id="loadingGrid" class="space-y-4">
            <div class="h-24 bg-white rounded-2xl border border-gray-100 animate-pulse"></div>
            <div class="h-24 bg-white rounded-2xl border border-gray-100 animate-pulse"></div>
            <div class="h-24 bg-white rounded-2xl border border-gray-100 animate-pulse"></div>
        </div>

        <!-- Lists -->
        <div id="eventGrid" class="space-y-3 hidden"></div>
        <div id="pastGrid" class="space-y-3 hidden"></div>

        <!-- Empty/Error States -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="far fa-calendar-times text-gray-300 text-3xl"></i>
            </div>
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">No matching events found</h3>
        </div>

        <div id="errorState" class="hidden max-w-sm mx-auto bg-white p-10 text-center border border-red-50 rounded-3xl card-shadow">
            <i class="fas fa-cloud-slash text-red-100 text-5xl mb-6"></i>
            <h2 class="text-sm font-bold text-gray-500 mb-8 uppercase tracking-widest leading-relaxed">Registry synchronization failed</h2>
            <button onclick="location.reload()" class="bg-red-800 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-red-900 transition-colors">
                Reconnect
            </button>
        </div>
    </main>

    <!-- Feedback Message -->
    <div id="copyToast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[60] bg-gray-900 text-white px-6 py-3 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4">
        List Copied to Clipboard
    </div>

    <!-- Floating Action Bar -->
    <div class="fixed bottom-8 left-0 right-0 z-40 px-6 flex justify-center pointer-events-none print:hidden">
        <button onclick="openBooking()" class="pointer-events-auto bg-red-800 text-white pl-6 pr-8 py-4 rounded-2xl font-bold flex items-center space-x-3 active:scale-95 transition-all shadow-2xl hover:shadow-red-800/40 group">
            <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center group-hover:bg-white/20 transition-colors">
                <i class="fas fa-hand-holding-heart text-lg"></i>
            </div>
            <div class="text-left">
                <span class="block text-[10px] text-white/60 uppercase font-black tracking-widest">Devasthanam</span>
                <span class="text-sm">Manage Seva Bookings</span>
            </div>
        </button>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-6 modal-overlay">
        <div class="bg-white w-full max-w-2xl rounded-t-[2.5rem] sm:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col h-[90vh] sm:h-[80vh]">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-4 mb-2 sm:hidden"></div>
            <div class="px-8 py-6 border-b border-gray-50 flex justify-between items-center bg-white sticky top-0 z-10">
                <div>
                    <h3 class="serif-title font-black text-gray-800 text-lg">Seva Management</h3>
                    <p class="text-[10px] text-red-800/60 font-bold uppercase tracking-widest">Sri Lakshmi Narasimha Devasthan</p>
                </div>
                <button onclick="closeBooking()" class="w-11 h-11 flex items-center justify-center rounded-2xl bg-gray-50 text-gray-400 hover:text-red-800 transition-all border border-gray-100">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto bg-white">
                <iframe id="tallyIframe" data-tally-src="https://tally.so/embed/VLJWyN?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="100%" frameborder="0" title="Lakshmi Narasimha Prasad Booking App" style="min-height: 600px;"></iframe>
            </div>
        </div>
    </div>

    <script src="https://tally.so/widgets/embed.js"></script>

    <script>
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQRkmuCc2IOP94Iy3nYVMN4_aaJF_uMyXTSkl6LenhcioG4yyqNG8EL9dJrq0y00xrxW3baPrvwNsJ9/pub?output=csv`;
        
        let allFuture = [];
        let allPast = [];
        let filteredFuture = [];
        let filteredPast = [];
        let currentView = 'upcoming'; // 'upcoming' or 'past'

        const ui = {
            grid: document.getElementById('eventGrid'),
            pastGrid: document.getElementById('pastGrid'),
            loader: document.getElementById('loadingGrid'),
            error: document.getElementById('errorState'),
            search: document.getElementById('searchInput'),
            clearSearch: document.getElementById('clearSearch'),
            count: document.getElementById('eventCount'),
            empty: document.getElementById('emptyState'),
            modal: document.getElementById('bookingModal'),
            iframe: document.getElementById('tallyIframe'),
            toast: document.getElementById('copyToast'),
            viewTitle: document.getElementById('viewTitle'),
            copyBtn: document.getElementById('copyBtn')
        };

        function parseCSV(text) {
            const rows = [];
            let row = [];
            let col = "";
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                let char = text[i];
                if (char === '"' && inQuotes && text[i+1] === '"') { col += '"'; i++; }
                else if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { row.push(col.trim()); col = ""; }
                else if ((char === '\r' || char === '\n') && !inQuotes) {
                    if (col !== "" || row.length > 0) { row.push(col.trim()); rows.push(row); }
                    row = []; col = "";
                    if (char === '\r' && text[i+1] === '\n') i++;
                } else col += char;
            }
            if (col !== "" || row.length > 0) { row.push(col.trim()); rows.push(row); }
            return rows;
        }

        function parseDate(str) {
            if (!str) return null;
            const parts = str.split(/[./-]/);
            if (parts.length === 3) {
                let d, m, y;
                if (parts[0].length === 4) { y = parseInt(parts[0]); m = parseInt(parts[1]); d = parseInt(parts[2]); }
                else { d = parseInt(parts[0]); m = parseInt(parts[1]); y = parseInt(parts[2]); }
                const date = new Date(y, m - 1, d);
                date.setHours(0,0,0,0);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        }

        async function fetchEvents() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const rawText = await response.text();
                const rows = parseCSV(rawText);
                
                if (rows.length < 2) throw new Error("No data found.");

                const now = new Date();
                now.setHours(0,0,0,0);

                const all = rows.slice(1).map((row, idx) => {
                    const dateObj = parseDate(row[3]);
                    const searchableDate = dateObj ? dateObj.toLocaleDateString('en-IN', {
                        weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
                    }).toLowerCase() : "";

                    return {
                        id: idx,
                        dateObj: dateObj,
                        rawDate: row[3],
                        searchableDate: searchableDate,
                        title: row[4] || 'Special Pooja & Event'
                    };
                }).filter(ev => ev.dateObj);

                allFuture = all.filter(ev => ev.dateObj >= now).sort((a, b) => a.dateObj - b.dateObj);
                allPast = all.filter(ev => ev.dateObj < now).sort((a, b) => b.dateObj - a.dateObj);
                
                filteredFuture = [...allFuture];
                filteredPast = [...allPast];

                renderLists();
                ui.loader.classList.add('hidden');
                updateView();
            } catch (err) {
                ui.loader.classList.add('hidden');
                ui.error.classList.remove('hidden');
            }
        }

        function createEventItem(event, index, isPast = false) {
            const item = document.createElement('div');
            item.className = `fade-in-item bg-white p-5 rounded-2xl card-shadow border border-red-50 flex items-center justify-between group cursor-text ${isPast ? 'past-event' : ''}`;
            item.style.animationDelay = `${index * 0.05}s`;
            
            const day = event.dateObj.getDate();
            const month = event.dateObj.toLocaleDateString('en-IN', { month: 'short' });
            const weekday = event.dateObj.toLocaleDateString('en-IN', { weekday: 'short' });

            item.innerHTML = `
                <div class="flex items-center space-x-5">
                    <div class="flex flex-col items-center justify-center w-14 h-14 ${isPast ? 'bg-gray-100 text-gray-400 border-gray-100' : 'bg-red-50 text-red-800 border-red-100'} rounded-xl border flex-shrink-0">
                        <span class="text-[9px] font-black uppercase tracking-tighter opacity-60 leading-none">${month}</span>
                        <span class="text-xl font-black">${day}</span>
                        <span class="text-[9px] font-bold opacity-60 leading-none">${weekday}</span>
                    </div>
                    <div class="flex flex-col">
                        <h3 class="text-sm md:text-base font-bold text-gray-800 leading-snug ${isPast ? '' : 'group-hover:text-red-800'} transition-colors">
                            ${event.title}
                        </h3>
                    </div>
                </div>
            `;
            return item;
        }

        function renderLists() {
            ui.grid.innerHTML = '';
            ui.pastGrid.innerHTML = '';

            filteredFuture.forEach((ev, i) => ui.grid.appendChild(createEventItem(ev, i)));
            filteredPast.forEach((ev, i) => ui.pastGrid.appendChild(createEventItem(ev, i, true)));
        }

        function setView(view) {
            currentView = view;
            
            // Update UI State
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active', 'text-gray-400');
                if (btn.id === `tab-${view}`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.add('text-gray-400');
                }
            });

            updateView();
        }

        function updateView() {
            const isEmpty = (currentView === 'upcoming' ? filteredFuture.length : filteredPast.length) === 0;
            
            if (currentView === 'upcoming') {
                ui.grid.classList.remove('hidden');
                ui.pastGrid.classList.add('hidden');
                ui.viewTitle.innerHTML = `<span class="w-2 h-2 bg-red-800 rounded-full mr-2"></span> Upcoming Registry`;
                ui.count.textContent = `${filteredFuture.length} UPCOMING EVENTS`;
            } else {
                ui.grid.classList.add('hidden');
                ui.pastGrid.classList.remove('hidden');
                ui.viewTitle.innerHTML = `<span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span> Past Records`;
                ui.count.textContent = `${filteredPast.length} PAST RECORDS`;
            }

            ui.empty.classList.toggle('hidden', !isEmpty);
        }

        function copyEvents() {
            const targetEvents = currentView === 'upcoming' ? filteredFuture : filteredPast;
            if (targetEvents.length === 0) return;
            
            const headerStr = currentView === 'upcoming' ? "UPCOMING EVENTS" : "PAST EVENTS";
            const text = `${headerStr} - SRI LAKSHMI NARASIMHA DEVASTHAN\n\n` + 
                targetEvents.map(ev => {
                    const date = ev.dateObj.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', weekday: 'short' });
                    return `â€¢ ${date}: ${ev.title}`;
                }).join('\n');

            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            ui.toast.classList.remove('opacity-0', 'translate-y-4');
            ui.toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                ui.toast.classList.remove('opacity-100', 'translate-y-0');
                ui.toast.classList.add('opacity-0', 'translate-y-4');
            }, 2500);
        }

        function openBooking() {
            ui.modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; 
            if (!ui.iframe.src) ui.iframe.src = ui.iframe.dataset.tallySrc;
            if (typeof Tally !== "undefined") Tally.loadEmbeds();
        }

        function closeBooking() {
            ui.modal.classList.add('hidden');
            document.body.style.overflow = ''; 
        }

        ui.modal.addEventListener('click', (e) => { if (e.target === ui.modal) closeBooking(); });

        ui.search.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            ui.clearSearch.classList.toggle('hidden', val.length === 0);
            
            filteredFuture = allFuture.filter(ev => ev.title.toLowerCase().includes(val) || ev.rawDate.includes(val) || ev.searchableDate.includes(val));
            filteredPast = allPast.filter(ev => ev.title.toLowerCase().includes(val) || ev.rawDate.includes(val) || ev.searchableDate.includes(val));
            
            renderLists();
            updateView();
        });

        ui.clearSearch.addEventListener('click', () => {
            ui.search.value = '';
            ui.clearSearch.classList.add('hidden');
            filteredFuture = [...allFuture];
            filteredPast = [...allPast];
            renderLists();
            updateView();
        });

        window.onload = fetchEvents;
    </script>
</body>
</html>
